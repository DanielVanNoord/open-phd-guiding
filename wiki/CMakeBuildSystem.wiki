#summary Unified cross-platform CMake build system

*Work in progress*

<wiki:toc max_depth="3" />

[http://www.cmake.org CMake] is a cross-platform meta-build system. The tool translates the rules for building, checking and installing the !OpenPhdGuiding project, written in the cmake language, 
into rules specific to your development environment and platform. The same script is used for creating Visual Studio or XCode project, or Makefile. 
The advantages of cmake are many, among which one can cite:
  * the maintenance of only one language for addressing the build of !OpenPhdGuiding on all platforms
  * the possibility to manage big projects and complex dependencies
  * the possibility to add unit tests and installation procedures

This page describes the steps to configure the !OpenPhdGuiding for your specific platform. If you need more information about CMake, a lot of information are available on the Internet. 

= Introduction =
The full build of the project in made in three steps
  # build and/or install the dependencies
  # configure cmake
  # build the project


= Preliminary notes =

== Checking out the code ==
The code is hosted on an SVN server located here: http://open-phd-guiding.googlecode.com/svn/. 
The branch that supports the cmake configuration is named *`new_build_system`*. The checkout command is then the following

{{{
svn checkout http://open-phd-guiding.googlecode.com/svn/branches/new_build_system open-phd-guiding
}}}

For that to work, you need an SVN client:

  * On Debian/Ubuntu, the installation would be
    {{{
    sudo apt-get install build-essential subversion
    }}}
  * On OSX, the svn client should be shipped with the OS (accessible from the terminal), 
  * and on Windows, there is TortoiseSVN that can be installed

From now on, we suppose the code has been checked out in *`$OPG_SRC`* (the `open-phd-guiding` path above).

== Development environments ==
The following development environment have been tested with the current `cmake` build system:
  * Windows: Visual Studio 2013 Express Edition
  * OSX: XCode 5, clang 5, and make
  * Linux: gcc4.6, make

== Supported architectures ==
Currently on Windows and OSX, the supported architecture is 32 bits only. This is because of the external libraries used in the project for driving specific astronomy hardware. Most of this specificity
is handled in the cmake script. However, the wxWidgets should be built accordingly. 

== Visual Studio versions ==
We suppose _Visual Studio 2013_ installed for Windows developers. The code name in _cmake_ for this version of Visual Studio is _Visual Studio 12_ ("12" stands for the version, which is _Visual Studio 2013_). 

== XCode versions ===
We suppose XCode 5 installed for Mac OSX developers. XCode 5 comes with _clang_ C++ compiler, which makes the compilation of _wxWidgets_ slightly more difficult than usual. 


= Project dependencies =
The cmake construction of !OpenPhdGuiding depends only on these external dependencies
  * CMake
  * wxWidget on all platforms
  * openCV on Windows
  * The [http://www.indilib.org/ Indi] and [http://libnova.sourceforge.net/ Nova] library packages on Ubuntu


This means that these dependencies should be available in order to be able to construct the project, and `cmake` should know where to find these dependencies. 
!OpenPhdGuiding has in fact many more dependencies, but they are shipped with the project and built within the project automatically (or chosen from the 
system wide installed libraries). These dependencies are:
  * openSSAG
  * libdc
  * libusb
  * cfitsio
  * and many more


== Installing CMake ==
[http://www.cmake.org CMake] provides binary installers for Windows and OSX. On Linux, you should be able to install `cmake` via the package manager
{{{
sudo apt-get install cmake
}}}

== Building and installing wxWidgets ==
We assume 
  * `$WXWIDGET_BASE_DIR` being a variable that points to the untarred sources of _wxWidgets_.
  * `$WXWIN` being a variable that points to the installation prefix of your dependencies.

=== Win32 ===
Open a Visual Studio console and type the following commands, respectively for the Debug and Release versions of the libraries.
{{{
cd $WXWIDGET_BASE_DIR\build\msw
msbuild wx_vc12.sln /p:configuration=Debug /p:platform=win32 /m:8
msbuild wx_vc12.sln /p:configuration=Release /p:platform=win32 /m:8
}}}

The `wx_vc12.sln` Visual Studio solution is for Visual Studio 12 (Visual 2013, see [#Visual_Studio_versions here]). 

=== OSX ===
The configuration on OSX looks a little bit complicated. We are using XCode 5 and above, which is shipped with Clang 3+.
{{{
cd $WXWIDGET_BASE_DIR
../configure --enable-universal_binary=i386,x86_64 --disable-shared --with-libpng=builtin --with-cocoa --prefix=$WXWIN \
             --with-macosx-sdk=/Applications/Xcode.app/Contents/Developer/Platforms/MacOSX.platform/Developer/SDKs/MacOSX10.9.sdk/ \
             --with-macosx-version-min=10.7 \
             CXXFLAGS="-stdlib=libc++ -std=c++11" \
             OBJCXXFLAGS="-stdlib=libc++ -std=c++11" \
             CPPFLAGS="-stdlib=libc++"  \
             LDFLAGS="-stdlib=libc++" CXX=clang++ CXXCPP="clang++ -E" CC=clang CPP="clang -E"
make
make install
}}}

=== Linux ===
Under Linux, the wxWidget should be available through the package manager. You need the _developer_ package using GTK:
{{{
sudo apt-get install libwxgtk3.0-dev wx-common wx3.0-i18n
}}}


== Installing Indi and Nova ==
On Linux, the Indi and Nova library packages should be available for the project. Simply run the following command to install them:

{{{
sudo apt-get install libindi-dev libnova-dev
}}}



== Building and installing OpenCV ==
We recall that the dependency on openCV is needed on Win32 platforms only. Nothing really needs to be built since the OpenCV
zip contains libraries already built for Windows, and also certainly for your platform. Just download OpenCV from [http://www.opencv.org the official website]
or [http://sourceforge.net/projects/opencvlibrary/ SourceForge].

We assume `$OPENCV_DIR` being a variable that points to the location where OpenCV was deflated. 

= Configuring the !OpenPhdGuiding project =
Once the dependencies available on your system, you are able to build the project. For that, you should inform the location of these dependencies to cmake, passed as options to cmake.
The basic scheme is
  # open a terminal. Under Windows, the terminal should be the one provided by the Visual Studio command line tool, which has the proper environment variables defining the compiler and the SDKs
  # go to the source directory *`$OPG_SRC`* and create a subdirectory where the project will be built
  # type the `cmake` command line with the proper options
  # open the generated project or make the project in place

== Creating the Visual Studio project ==
We suppose you have 
  * CMake
  * Visual Studio 12 installed (see [#Visual_Studio_versions here] for more details)
  * build properly [#Building_and_installing_wxWidgets  wxWidgets] and [#Building_and_installing_OpenCV OpenCV]

{{{
cd $OPG_SRC
mkdir tmp
cd tmp
cmake -G "Visual Studio 12" -DwxWidgets_ROOT_DIR=$WXWIN  -DOpenCVRoot=$OPENCV_DIR\opencv\build ..
PhD2.sln
}}}

The last line opens the solution in Visual Studio.

== Creating the XCode project on OSX ==
We suppose you have 
  * CMake
  * XCode installed
  * build properly [#Building_and_installing_wxWidgets  wxWidgets]

{{{
cd $OPG_SRC
mkdir tmp
cd tmp
cmake -G Xcode -DwxWidgets_PREFIX_DIRECTORY=$WXWIN -DCMAKE_OSX_ARCHITECTURES=i386 -DCMAKE_C_FLAGS=-m32 -DCMAKE_CXX_FLAGS=-m32 ..
open PhD2.xcodeproj
}}}

The last line opens the project in XCode.


== Creating the Makefiles on Linux ==
We suppose you have 
  * CMake
  * a compilation toolchain (eg. `gcc`, `ld`, `make`...)
  * installed [#Building_and_installing_wxWidgets  wxWidgets]
  * installed [#Installing_Indi_and_Nova Indi and Nova] library packages

{{{
cd $OPG_SRC
mkdir tmp
cd tmp
cmake -DwxWidgets_PREFIX_DIRECTORY=$WXWIN ..
make -j 4
}}}
