#summary OpenPHD Event Monitoring interface

<wiki:toc max_depth="3" />

= Introduction =

OpenPHD allows programs to connect to PHD to actively monitor guiding status and control PHD. This allows clients to do things like:
  * graph phd data in real time
  * monitor phd for exceptional events like guiding lost, and send an alert when something goes wrong
  * control PHD remotely

= Connection =

Clients connect to PHD on TCP port 4400. When multiple PHD instances are running, each instance listens on successive port numbers (4401, 4402, ...).

PHD allows multiple clients to establish connections simultaneously.

When a client establishes a connection, PHD sends a series of event notification messages to the client (see [#Initial_Messages]). Then, as guiding events take place in PHD, notification messages are sent to all connected clients.

= Event Notification Messages =

== Event Notification Message Format ==

Event Notification messages are formatted as [http://www.json.org/ JSON] objects. Each message is a single line of text terminated by CR LF.

== Common attributes ==

All messages contain the following attributes in common:

|| Attribute || Type || Description ||
||`Event` || string || the name of the event ||
|| `Timestamp` || number || the timesamp of the event in seconds from the epoch, including fractional seconds ||
|| `Host` || string || the hostname of the machine running PHD ||
|| `Inst` || number || the PHD instance number (1-based) ||

== Event Message Descriptions ==

Here are the available messages and the attributes of each message.

=== `Version` ===

Describes the PHD and message protocol versions.

|| Attribute || Type || Description ||
|| `PHDVersion` || string || the PHD version number ||
|| `PHDSubver` || string || the PHD sub-version number ||
|| `MsgVersion` || number || the version number of the event message protocol. The current version is 1. We will bump this number if the message protocol changes. ||

Example
{{{
{"Event":"Version","Timestamp":1372082668.897,"Host":"AGALASSO","Inst":1,"PHDVersion":"2.0.4","PHDSubver":"a","MsgVersion":1}
}}}

=== `LockPositionSet` ===

The lock position has been established.

|| Attribute || Type || Description ||
|| X || number || lock position X-coordinate ||
|| Y || number || lock position Y-coordinate ||

=== `CalibrationComplete` ===

Calibration completed successfully.

|| Attribute || Type || Description ||
|| Mount || string || name of the mount that was calibrated ||

=== `StarSelected` ===

A star has been selected.

|| Attribute || Type || Description ||
|| X || number || lock position X-coordinate ||
|| Y || number || lock position Y-coordinate ||

=== `StartGuiding` ===

Guiding begins.

(no message attributes)

=== `Paused` ===

Guiding has been paused.

|| Attribute || Type || Description ||

=== `StartCalibration` ===

Calibration begins.

|| Attribute || Type || Description ||
|| Mount || string || the name of the mount being calibrated ||

=== `AppState` ===

|| Attribute || Type || Description ||
|| State || string || the current state of PHD ||

The state attribute can be one of the following:

|| State || Description ||
|| Stopped || PHD is idle ||
|| Selected || A star is selected but PHD is neither looping exposures, calibrating, or guiding ||
|| Calibrating || PHD is calibrating ||
|| Guiding || PHD is guiding ||
|| LostLock  || PHD has lost its lock position ||
|| Paused || PHD is paused ||
|| Looping || PHD is looping exposures ||

=== `CalibrationFailed` ===

Calibration failed.

|| Attribute || Type || Description ||
|| Reason || string || an error message string ||

=== `CalibrationDataFlipped` ===

Calibration data has been flipped.

|| Attribute || Type || Description ||
|| Mount || string || the name of the mount ||

=== `LoopingExposures` ===

Sent for each exposure frame while looping exposures.

|| Attribute || Type || Description ||
|| Frame || number || the exposure frame number; starts at 1 each time looping starts ||

=== `LoopingExposuresStopped` ===

Looping exposures has stopped.

(no event attributes)

=== `StarLost` ===

The selected star has been lost.

(no event attributes)

=== `GuidingStopped` ===

Guiding has stopped.

(no event attributes)

=== `Resumed` ===

PHD has been resumed after having been paused.

(no attributes)

=== `GuideStep` ===

This event corresponds to a line in the PHD Guide Log. The event is sent for each frame while guiding.

|| Attribute || Type || Description ||
||Frame||number||The frame number; starts at 1 each time guiding starts||
||Time||number|| the time in seconds, including fractional seconds, since guiding started||
||mount||string||the name of the mount||
||dx||number||the X-offset in pixels||
||dy||number||the Y-offset in pixels||
||RADistanceRaw||number||the RA distance in pixels of the guide offset vector||
||DecDistanceRaw||number||the Dec distance in pixels of the guide offset vector||
||RADistanceGuide||number||the guide algorithm-modified RA distance in pixels of the guide offset vector||
||DecDistanceGuide||number||the guide algorithm-modified Dec distance in pixels of the guide offset vector||
||RADuration||number||the RA guide pulse duration in milliseconds||
||RADirection||string||"E" or "W"||
||DECDuration||number||the Dec guide pulse duration in milliseconds||
||DECDirection||string||"S" or "N"||
||StarMass||number||the Star Mass value of the guide star||
||SNR||number||the computed Signal-to-noise ratio of the guide star||
||ErrorCode||number||the star finder error code||

=== `GuidingDithered` ===

The lock position has been dithered.

|| Attribute || Type || Description ||
||dx||number||the dither X-offset in pixels||
||dy||number||the dither Y-offset in pixels||

=== `LockPositionLost` ===

The lock position has been lost.

(no attributes)

== Initial Event Messages ==

When a client first connects, PHD sends a series of event messages to the client. The first event is
 * `Version`
Then, one or more of
 * `LockPositionSet`
 * `StarSelected`
 * `CalibrationComplete`
 * `StartGuiding`, `StartCalibration`, or `Paused`
depending on the state of PHD.

Finally, PHD will send
 * `AppState`

= PHD Server method invocation =

PHD2 provides an RPC (remote procedure call) interface for event server clients. The message protocol is [http://www.jsonrpc.org/specification JSON RPC 2.0].

Requests are sent as a single line of text, terminated by `CR LF`. Responses from the server are also a single line of text terminated by `CR LF`.

Here is an example exchange between client ({{{-->}}}) and server ({{{<--}}}):

Get current camera exposure time:
{{{
--> {"method": "get_exposure", "id": 1}
<-- {"jsonrpc": "2.0", "result": 1000, "id": 1}
}}}

Set camera exposure:
{{{
--> {"method": "set_exposure", "params": [1500], "id": 2}
<-- {"jsonrpc": "2.0", "result": 0, "id": 2}
}}}

Set camera exposure (error):
{{{
--> {"method": "set_exposure", "params": [1502], "id": 3}
<-- {"jsonrpc": "2.0", "error": {"code": 1, "message": "could not set exposure duration"}, "id": 3}
}}}

== Available Methods ==

||*Method*||*params*||*result*||*Description*||
||`get_calibrated`||none||boolean: true if calibrated|| ||
||`get_connected`||none||boolean: true if all equipment is connected || ||
||`get_exposure`||none||integer: exposure time in milliseconds|| ||
||`get_exposure_durations`||none||array of integers: the list of valid exposure times in milliseconds || ||
||`get_profile`||none||{{{ {"id":profile_id,"name":"profile_name"} }}} ||
||`get_profiles`||none||array of {{{ {"id":profile_id,"name":"profile_name"} }}} ||
||`set_connected`||boolean: connect|| integer (0) || connect or disconnect all equipment ||
||`set_exposure`||integer: exposure time in milliseconds|| integer (0)||
||`set_profile`||integer: profile id|| integer (0) || Select an equipment profile. All equipment must be disconnected before switching profiles. ||